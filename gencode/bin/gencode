#!/usr/bin/env php
<?php

use Arimac\Sigfox\GenCode\Definition;
use cebe\openapi\Reader;

use function Arimac\Sigfox\GenCode\Utils\defToName;
use function Arimac\Sigfox\GenCode\Utils\rrmdir;

$dir = dirname(__DIR__);

require_once $dir . "/vendor/autoload.php";

$openapiFileLocation = $dir . "/tmp/openapi.json";
$openapiUrl = "https://support.sigfox.com/api/apidocs";
if (!file_exists($openapiFileLocation)) {
    file_put_contents($openapiFileLocation, fopen($openapiUrl, 'r'));
}

rrmdir($dir . "/../src/Definition");
mkdir($dir . "/../src/Definition");

$openapi = Reader::readFromJsonFile($openapiFileLocation);

$simpleAlias = ["Resources", "Resource", "Actions", "Action"];

function typeCast(Definition $defClass, string $type, array $obj = []): string
{
    switch ($type) {
        case "integer":
            return "int";
        case "number":
            if (isset($obj["format"]) && $obj["format"] == "double") {
                return "float";
            }
            return "int";
        case "boolean":
            return "bool";
        case "string":
            return "string";
        case "Actions":
            return "string[]";
        case "Resources":
            return "string[]";
        case "Action":
            return "string";
        case "Resource":
            return "string";
        case "array":
            $items = $obj["items"];
            if (isset($items["\$ref"])) {
                $definition = defToName($items["\$ref"]);
                $defClass->addUse("Arimac\\Sigfox\\Definition", $definition);
                return $definition . "[]";
            } else if ($items["type"] != "object") {
                return typeCast($defClass, $items["type"], $items) . "[]";
            }
        default:
            $defClass->addUse($defClass->getNamespace(), $type);
            return $type;
    }
}

function addProperties(Definition $defClass, $definition)
{
    if (isset($definition["properties"]) && isset($definition["type"]) && $definition["type"] == "object") {
        $required = $definition["required"] ?? [];
        if (isset($definition['required'])) {
            $defClass->setRequired($definition['required']);
        }
        $objects = [];
        foreach ($definition["properties"] as $propertyName => $propertyAttr) {
            if (isset($propertyAttr["type"]) && $propertyAttr["type"] == "object") {
                if (
                    isset($propertyAttr["allOf"]) &&
                    count($propertyAttr["allOf"]) == 1 &&
                    isset($propertyAttr["allOf"][0]["\$ref"])
                ) {
                    $defName = defToName($propertyAttr["allOf"][0]["\$ref"]);
                    if (!in_array($defName, ["Resources", "Resource", "Actions", "Action"])) {
                        $objects[$propertyName] = "\\Arimac\\Sigfox\\Definition\\$defName";
                    }
                    $defClass->addProperty(
                        $propertyName,
                        typeCast($defClass, $defName, $propertyAttr),
                        !in_array($propertyName, $required),
                        $propertyAttr["description"] ?? null
                    );
                } else if (count($propertyAttr["properties"])) {
                    $propertyDefClass = Definition::fromArray(
                        $defClass->getNamespace() . "\\" . $defClass->getClassName(),
                        ucfirst($propertyName),
                        $propertyAttr
                    );
                    $propertyDefClass->save();
                    $defClass->addProperty(
                        $propertyName,
                        typeCast($defClass, $defClass->getClassName() . "\\" . $propertyDefClass->getClassName(), $propertyAttr),
                        !in_array($propertyName, $required),
                        $propertyAttr["description"] ?? null
                    );
                } else {
                    $defClass->addProperty(
                        $propertyName,
                        "array",
                        !in_array($propertyName, $required),
                        $propertyAttr["description"] ?? null
                    );
                }
            } else if (
                isset($propertyAttr["type"]) &&
                $propertyAttr["type"] == "array" &&
                isset($propertyAttr["items"]["type"]) &&
                $propertyAttr["items"]["type"] == "object"
            ) {
                $propertyDefClass = Definition::fromArray(
                    $defClass->getNamespace() . "\\" . $defClass->getClassName(),
                    ucfirst($propertyName) . "Item",
                    $propertyAttr["items"]
                );
                $propertyDefClass->save();
                $defClass->addProperty(
                    $propertyName,
                    typeCast(
                        $defClass,
                        $defClass->getClassName() . "\\" . $propertyDefClass->getClassName() . "Item",
                        $propertyAttr
                    ),
                    !in_array($propertyName, $required),
                    $propertyAttr["description"] ?? null
                );
            } else if (isset($propertyAttr["type"])) {
                $defClass->addProperty(
                    $propertyName,
                    typeCast($defClass, $propertyAttr["type"], $propertyAttr),
                    !in_array($propertyName, $required),
                    $propertyAttr["description"] ?? null
                );
            } else if (isset($propertyAttr["\$ref"])) {
                $defName = defToName($propertyAttr["\$ref"]);
                if (!in_array($defName, ["Resources", "Resource", "Actions", "Action"])) {
                    $objects[$propertyName] = "\\Arimac\\Sigfox\\Definition\\$defName";
                }
                $defClass->addProperty(
                    $propertyName,
                    typeCast($defClass, $defName, $propertyAttr),
                    !in_array($propertyName, $required),
                    $propertyAttr["description"] ?? null
                );
            }
        }
        if (count($objects)) {
            $defClass->setObjects($objects);
        }
    }
}

foreach ($openapi->definitions as $key => $definition) {
    $name = ucfirst($key);
    if (!in_array($name, $simpleAlias)) {

        $defClass = Definition::fromArray("Arimac\\Sigfox\\Definition", $name, $definition);
        $defClass->save();
    }
}
