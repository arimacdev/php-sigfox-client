#!/usr/bin/env php
<?php

use Arimac\Sigfox\GenCode\Definition;
use Arimac\Sigfox\GenCode\Config\EnumFields;
use Arimac\Sigfox\GenCode\Config\MethodNames;
use Arimac\Sigfox\GenCode\Config\RewriteRules;
use Arimac\Sigfox\GenCode\Helper;
use Arimac\Sigfox\GenCode\Repository;
use Arimac\Sigfox\GenCode\Request;

$dir = dirname(__DIR__);

require_once $dir . "/vendor/autoload.php";

$openapiFileLocation = $dir . "/tmp/openapi.json";
$openapiUrl = "https://support.sigfox.com/api/apidocs";
if (!file_exists($openapiFileLocation)) {
    file_put_contents($openapiFileLocation, fopen($openapiUrl, 'r'));
}

Helper::rrmdir($dir . "/../src/Definition");
mkdir($dir . "/../src/Definition");

$openapi = json_decode( file_get_contents($openapiFileLocation) , true);

EnumFields::initialize();
RewriteRules::initialize();
MethodNames::initialize();

$simpleAlias = ["Resources", "Resource", "Actions", "Action"];


foreach ($openapi["definitions"] as $key => $definition) {
    $name = ucfirst($key);
    if (!in_array($name, $simpleAlias)) {
        $defClass = Definition::fromArray("Arimac\\Sigfox\\Definition\\$name", $definition);
    }
}

foreach ($openapi["paths"] as $endpoint => $operations){
    $rewrite = RewriteRules::rewrite($endpoint);
    foreach($operations as $method=> $operation){
        if($method!=="parameters"){
            $methodName = MethodNames::getMethodName($endpoint, $method, $operation["description"]);
        }
    }
}

/** @var Repository[] **/

$repositories = [];

foreach ($openapi["paths"] as $endpoint => $path) {
    $rewrite = RewriteRules::rewrite($endpoint);
    $slices = explode("/", $rewrite);
    $repoName = "";
    $requestMethods = array_keys($path);
    $requestMethods = array_filter($requestMethods, function($method){
        return $method!="parameters"; 
    });
    $operation = $path[$requestMethods[0]];
    $params = isset($operation["parameters"])? $operation["parameters"]: [];
    $pathParams = [];
    foreach ($params as $param) {
        if ($param["in"] === "path") {
            $type = $param["typ"] ?? "string";
            $description = $param["description"];
            $pathParams[$param["name"]] = [
                "type" => Helper::toPHPValue($type),
                "description" => $description
            ];
        }
    }

    foreach ($slices as $slice) {
        if ($slice !== "") {
            $repoNameSlice = "";
            $parameter = false;
            if (substr($slice, 0, 1) === "{") {
                $parameter = true;
                $repoNameSlice = Helper::dashToCamel(substr($slice, 1, strlen($slice) - 2));
            } else {
                $repoNameSlice = Helper::dashToCamel($slice);
            }
            $previousRepoName = $repoName;
            $repoName .= $repoNameSlice;

            if (!isset($repositories[$repoName])) {
                $repository = new Repository("Arimac\\Sigfox\\Repository", $repoName);
                /** @var Repository **/
                $prevRepository = $repositories[$previousRepoName] ?? null;
                $repositories[$repoName] = $repository;

                $properties = $prevRepository ? $prevRepository->getProperties() : [];

                if ($parameter) {
                    $paramName = lcfirst($repoNameSlice);
                    $type = $pathParams[$paramName]["type"];
                    $description = $pathParams[$paramName]["description"];

                    $properties[] = [$paramName, $type, $description];
                    $prevRepository->addFindMethod(
                        $paramName,
                        $type,
                        "Arimac\\Sigfox\\Repository\\$repoName",
                        Helper::normalizeDocComment(
                            "Find by $paramName", 
                            [
                                ["param", "$type", "\$$paramName", $description],
                                ["return","$repoName", null ]
                            ]
                        )
                    );
                } else if ($prevRepository) {
                    $methodName = lcfirst($repoNameSlice);
                    $prevRepository->addRepositoryMethod($methodName,"Arimac\\Sigfox\\Repository\\". $repoName);
                }

                if (count($properties)) {
                    $repository->addConstructor($properties);
                }
            }
        }
    }

    foreach ($requestMethods as $requestMethod) {
        $description = $path[$requestMethod]["description"];
        $methodName = MethodNames::getMethodName($endpoint, $requestMethod, $description);

        $requestClassName = $repoName . ucfirst($methodName);

        $operation = $path[$requestMethod];

        $requestType = Request::fromArray("Arimac\\Sigfox\\Request\\$requestClassName", $operation);

        $repository->addRequestMethod(
            $methodName, 
            $requestMethod, 
            $endpoint, 
            "int", 
            $requestType==="null"?null:$requestType, 
            Helper::normalizeDocComment($description)
        );
    }
}

foreach ($repositories as $repoName => $repo) {
    $repo->save();
}

EnumFields::save();
RewriteRules::save();
MethodNames::save();
